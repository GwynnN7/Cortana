#!/usr/bin/zsh
cd ~/Cortana || exit;

if (($# == 1))
then
    if [ "$1" = "update" ] || [ "$1" = "-u" ]
    then
	    git fetch --all && git pull;
    elif [ "$1" = "run" ] || [ "$1" = "-r" ]
    then
	      rm -rf .log;
        mkdir .log;
        dotnet build CortanaKernel -o CortanaKernel/out --artifacts-path CortanaKernel/out/lib;
        nohup CortanaKernel/out/CortanaKernel >>.log/Cortana.log 2>>.log/Cortana.err & disown;
        echo "Cortana started!";
    elif [ "$1" = "start" ] || [ "$1" = "-s" ]
    then
        rm -rf .log;
        mkdir .log;
        dotnet build CortanaKernel -o CortanaKernel/out --artifacts-path CortanaKernel/out/lib;
        CortanaKernel/out/CortanaKernel;
    elif [ "$1" = "restart" ] || [ "$1" = "-rs" ]
    then
	      cmd="sleep 5 && cortana run";
        cortana update;
        eval "${cmd}" &>/dev/null & disown;
        cortana stop;
    elif [ "$1" = "reset" ] || [ "$1" = "-rt" ]
    then
        rm -rf ./*
	      git fetch --all && git reset --hard origin/main;
    elif [ "$1" = "stop" ] || [ "$1" = "-k" ]
    then
        killall -s SIGUSR1 --quiet --ignore-case --wait CortanaKernel;
        echo "Cortana stopped"
    elif [ "$1" = "stop" ] || [ "$1" = "-kf" ]
    then
        killall -s SIGKILL --quiet --ignore-case --wait CortanaKernel;
        echo "Cortana stopped"
	elif [ "$1" = "help" ] || [ "$1" = "-h" ]
    then
      echo "cortana update -u    git fetch and pull";
      echo "cortana reset -rt    git fetch and reset"
      echo "cortana stop -k      stops cortana safely"
      echo "cortana kill -kf     stops cortana immediately"
      echo "cortana run -r       boots up cortana"
      echo "cortana start -s     boots up cortana"
      echo "cortana restart -rs  update and restart"
    fi
fi
